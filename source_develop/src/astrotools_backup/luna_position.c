#include <stdio.h>
#include <math.h>
#include "astrotools.h"

/****
#define __DEBUG__
****/

void luna_position(int  *TimUT, double UT1_UTC, 
                   double Lambda, double fai, double h,
                   double *RA, double *DC)
{
  double e[3], Q[4], AA[3][3], s[3], luna[3], earth[3];
  double lambda, A, beta, B, sin_pi;
  double t, r, ae = 6378140.0;
  double dpi = 3.141592653589793238462643;
  double DPI;

/*
--------
*/

  DPI = dpi / 180.0;

  t = ET(TimUT, UT1_UTC);
  A      = 0.0040 * sin (DPI*( 93.8   -    1.33  *t))
         + 0.0020 * sin (DPI*(248.6   -   19.34  *t))
         + 0.0006 * sin (DPI*( 66.0   +    0.2   *t))
         + 0.0006 * sin (DPI*(249.0   -   19.3   *t));
  A     *= DPI;
  lambda = 124.8754 + 4812.67881*t
         + 6.2887 * sin (DPI*(338.915 +  4771.9886*t + A))
         + 1.2740 * sin (DPI*(107.248 -  4133.3536*t))
         + 0.6583 * sin (DPI*( 51.668 +  8905.3422*t))
         + 0.2136 * sin (DPI*(317.831 +  9543.9773*t))
         + 0.1856 * sin (DPI*(176.531 +   359.9905*t))

         + 0.1143 * sin (DPI*(292.463 +  9664.0404*t))
         + 0.0588 * sin (DPI*( 86.16  +   638.635 *t))
         + 0.0572 * sin (DPI*(103.78  -  3773.363 *t))
         + 0.0533 * sin (DPI*( 30.58  + 13677.331 *t))
         + 0.0459 * sin (DPI*(124.86  -  8545.352 *t))

         + 0.0410 * sin (DPI*(342.38  +  4411.998 *t))
         + 0.0348 * sin (DPI*( 25.83  +  4452.671 *t))
         + 0.0305 * sin (DPI*(155.45  +  5131.979 *t))
         + 0.0153 * sin (DPI*(240.79  +   758.698 *t))
         + 0.0125 * sin (DPI*(271.38  + 14436.029 *t))

         + 0.0110 * sin (DPI*(226.45  -  4892.052 *t))
         + 0.0107 * sin (DPI*( 55.58  - 13038.696 *t))
         + 0.0100 * sin (DPI*(296.75  + 14315.966 *t))
         + 0.0085 * sin (DPI*( 34.5   -  8266.71  *t))
         + 0.0079 * sin (DPI*(290.7   -  4493.34  *t))

         + 0.0068 * sin (DPI*(228.2   +  9265.33  *t))
         + 0.0052 * sin (DPI*(133.1   +   319.32  *t))
         + 0.0050 * sin (DPI*(202.4   +  4812.66  *t))
         + 0.0048 * sin (DPI*( 68.6   -    19.34  *t))
         + 0.0040 * sin (DPI*( 34.1   + 13317.34  *t))

         + 0.0040 * sin (DPI*(  9.5   + 18449.32  *t))
         + 0.0040 * sin (DPI*( 93.8   -     1.33  *t))
         + 0.0039 * sin (DPI*(103.3   + 17810.68  *t))
         + 0.0037 * sin (DPI*( 65.1   +  5410.62  *t))
         + 0.0027 * sin (DPI*(321.3   +  9183.99  *t))

         + 0.0026 * sin (DPI*(174.8   - 13797.39  *t))
         + 0.0024 * sin (DPI*( 82.7   +   998.63  *t))
         + 0.0024 * sin (DPI*(  4.7   +  9224.66  *t))
         + 0.0022 * sin (DPI*(121.4   -  8185.36  *t))
         + 0.0021 * sin (DPI*(134.4   +  9903.97  *t))

         + 0.0021 * sin (DPI*(173.1   +   719.98  *t))
         + 0.0021 * sin (DPI*(100.3   -  3413.37  *t))
         + 0.0020 * sin (DPI*(248.6   -    19.34  *t))
         + 0.0018 * sin (DPI*( 98.1   +  4013.29  *t))
         + 0.0016 * sin (DPI*(344.1   + 18569.38  *t))

         + 0.0012 * sin (DPI*( 52.1   - 12678.71  *t))
         + 0.0011 * sin (DPI*(250.3   + 19208.02  *t))
         + 0.0009 * sin (DPI*( 81.0   -  8586.0   *t))
         + 0.0008 * sin (DPI*(207.0   + 14037.3   *t))
         + 0.0008 * sin (DPI*( 31.0   -  7906.7   *t))

         + 0.0007 * sin (DPI*(346.0   +  4052.0   *t))
         + 0.0007 * sin (DPI*(294.0   -  4853.3   *t))
         + 0.0007 * sin (DPI*( 90.0   +   278.6   *t))
         + 0.0006 * sin (DPI*(237.0   +  1118.7   *t))
         + 0.0005 * sin (DPI*( 82.0   + 22582.7   *t))

         + 0.0005 * sin (DPI*(276.0   + 19088.0   *t))
         + 0.0005 * sin (DPI*( 73.0   - 17450.7   *t))
         + 0.0005 * sin (DPI*(112.0   +  5091.3   *t))
         + 0.0004 * sin (DPI*(116.0   -   398.7   *t))
         + 0.0004 * sin (DPI*( 25.0   -   120.1   *t))

         + 0.0004 * sin (DPI*(181.0   +  9584.7   *t))
         + 0.0004 * sin (DPI*( 18.0   +   720.0   *t))
         + 0.0003 * sin (DPI*( 60.0   -  3814.0   *t))
         + 0.0003 * sin (DPI*( 13.0   -  3494.7   *t))
         + 0.0003 * sin (DPI*( 13.0   + 18089.3   *t))

         + 0.0003 * sin (DPI*(152.0   +  5492.0   *t))
         + 0.0003 * sin (DPI*(317.0   -    40.7   *t))
         + 0.0003 * sin (DPI*(348.0   + 23221.3   *t));
  lambda*= DPI;
  B      = 0.0267 * sin (DPI*( 68.64  -    19.341 *t))
         + 0.0043 * sin (DPI*(342.0   -    19.36  *t))
         + 0.0040 * sin (DPI*( 93.8   -     1.33  *t))
         + 0.0020 * sin (DPI*(248.6   -    19.34  *t))
         + 0.0005 * sin (DPI*(358.0   -    19.4   *t));
  B     *= DPI;
  beta   = 5.1282 * sin (DPI*(236.231 +  4832.0202*t + B))
         + 0.2806 * sin (DPI*(215.147 +  9604.0088*t))
         + 0.2777 * sin (DPI*( 77.316 +    60.0316*t))
         + 0.1732 * sin (DPI*(  4.563 -  4073.3220*t))
         + 0.0554 * sin (DPI*(308.98  +  8965.374 *t))

         + 0.0463 * sin (DPI*(343.48  +   698.667 *t))
         + 0.0326 * sin (DPI*(287.90  + 13737.362 *t))
         + 0.0172 * sin (DPI*(194.06  + 14375.997 *t))
         + 0.0093 * sin (DPI*( 25.6   -  8845.31  *t))
         + 0.0088 * sin (DPI*( 98.4   -  4711.96  *t))

         + 0.0082 * sin (DPI*(  1.1   -  3713.33  *t))
         + 0.0043 * sin (DPI*(322.4   +  5470.66  *t))
         + 0.0042 * sin (DPI*(266.8   + 18509.35  *t))
         + 0.0034 * sin (DPI*(188.0   -  4433.31  *t))
         + 0.0025 * sin (DPI*(312.5   +  8605.38  *t))

         + 0.0022 * sin (DPI*(291.4   + 13377.37  *t))
         + 0.0021 * sin (DPI*(340.0   +  1058.66  *t))
         + 0.0019 * sin (DPI*(218.6   +  9244.02  *t))
         + 0.0018 * sin (DPI*(291.8   -  8206.68  *t))
         + 0.0018 * sin (DPI*( 52.8   +  5192.01  *t))

         + 0.0017 * sin (DPI*(168.7   + 14496.06  *t))
         + 0.0016 * sin (DPI*( 73.8   +   420.02  *t))
         + 0.0015 * sin (DPI*(262.1   +  9284.69  *t))
         + 0.0015 * sin (DPI*( 31.7   +  9964.00  *t))
         + 0.0014 * sin (DPI*(260.8   -   299.96  *t))

         + 0.0013 * sin (DPI*(239.7   +  4472.03  *t))
         + 0.0013 * sin (DPI*( 30.4   +   379.35  *t))
         + 0.0012 * sin (DPI*(304.9   +  4812.68  *t))
         + 0.0012 * sin (DPI*( 12.4   -  4851.36  *t))
         + 0.0011 * sin (DPI*(173.0   + 19147.99  *t))

         + 0.0010 * sin (DPI*(312.9   - 12978.66  *t))
         + 0.0008 * sin (DPI*(  1.0   + 17870.7   *t))
         + 0.0008 * sin (DPI*(190.0   +  9724.1   *t))
         + 0.0007 * sin (DPI*( 22.0   + 13098.7   *t))
         + 0.0006 * sin (DPI*(117.0   +  5590.7   *t))

         + 0.0006 * sin (DPI*( 47.0   - 13617.3   *t))
         + 0.0005 * sin (DPI*( 22.0   -  8485.3   *t))
         + 0.0005 * sin (DPI*(150.0   +  4193.4   *t))
         + 0.0004 * sin (DPI*(119.0   -  9483.9   *t))
         + 0.0004 * sin (DPI*(246.0   + 23281.3   *t))

         + 0.0004 * sin (DPI*(301.0   + 10242.6   *t))
         + 0.0004 * sin (DPI*(126.0   +  9325.4   *t))
         + 0.0004 * sin (DPI*(104.0   + 14097.4   *t))
         + 0.0003 * sin (DPI*(340.0   + 22642.7   *t))
         + 0.0003 * sin (DPI*(270.0   + 18149.4   *t))

         + 0.0003 * sin (DPI*(358.0   -  3353.3   *t))
         + 0.0003 * sin (DPI*(148.0   + 19268.0   *t));
  beta  *= DPI;
  sin_pi = 0.9507
         + 0.0518 * cos (DPI*(338.92  +  4771.989 *t))
         + 0.0095 * cos (DPI*(287.2   -  4133.35  *t))
         + 0.0078 * cos (DPI*( 51.7   +  8905.34  *t))
         + 0.0028 * cos (DPI*(317.8   +  9543.98  *t))
         + 0.0009 * cos (DPI*( 31.0   + 13677.3   *t))

         + 0.0005 * cos (DPI*(305.0   -  8545.4   *t))
         + 0.0004 * cos (DPI*(284.0   -  3773.4   *t))
         + 0.0003 * cos (DPI*(342.0   +  4412.0   *t));
  sin_pi *= DPI;
  r = ae / sin_pi;

  s[0] = cos(beta) * cos(lambda);
  s[1] = cos(beta) * sin(lambda);
  s[2] = sin(beta);
  e[0] = 1.0;
  e[1] = 0.0;
  e[2] = 0.0;
  coordinate_rotation(e, EPSIRON(t), Q, AA[0], s, luna);

  luna[0] *= r;
  luna[1] *= r;
  luna[2] *= r;
  topocentric_equatorial_rectangular_coordinate(TimUT, UT1_UTC,
                                                Lambda, fai, h, earth);
  luna[0] -= earth[0];
  luna[1] -= earth[1];
  luna[2] -= earth[2];

  *RA = atan2(luna[1], luna[0]);
  *DC = atan2(luna[2], sqrt(luna[0]*luna[0] + luna[1]*luna[1]));

  return;
}
